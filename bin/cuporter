#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)
require 'cuporter'

filter_args = Cuporter::CLI::FilterArgsBuilder.new(Cuporter.options[:tags]).args

report = Cuporter::ReportBase.create(Cuporter.options[:report], 
                                 Cuporter::CLI::Options.input_file_pattern,
                                 Cuporter.options[:input_dir],
                                 filter_args,
                                 Cuporter.options[:format], 
                                 Cuporter.options[:title]).build

puts case Cuporter.options[:format]
when 'xml'
  report.to_xml(:indent => 2, :encoding => 'UTF-8')
when 'text', 'csv', 'pretty'
  report.to_text(:format => Cuporter.options[:format])
when 'html'
  html = Cuporter::Document.new_html(Cuporter.options[:report])
  xslt = Nokogiri::XSLT(File.read("lib/cuporter/formatter/xml_to_html.xslt"))
  html.add_report(xslt.transform(report).at('.report'))
  html.to_html
end

__END__
xsltproc --stringparam view feature lib/cuporter/formatter/xml_to_html.xslt new_feature.xml | ruby -e "f = STDIN.read; puts f.gsub(/\<\!--[\*\/]{2}--\>/, '')" | tee xslt_feature.html
